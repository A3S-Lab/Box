# A3S Box Code (Guest Agent) - Justfile

# Default recipe
default:
    @just --list

# Build
build:
    cargo build -p a3s-box-code

# Build in release mode
build-release:
    cargo build -p a3s-box-code --release

# Run tests
test:
    cargo test -p a3s-box-code

# Run tests with output
test-verbose:
    cargo test -p a3s-box-code -- --nocapture

# Run a specific test
test-one TEST:
    cargo test -p a3s-box-code -- {{TEST}}

# Format code
fmt:
    cargo fmt -p a3s-box-code

# Check formatting
fmt-check:
    cargo fmt -p a3s-box-code -- --check

# Run clippy
lint:
    cargo clippy -p a3s-box-code --all-targets -- -D warnings

# Run clippy with fixes
lint-fix:
    cargo clippy -p a3s-box-code --all-targets --fix --allow-dirty

# Check compilation
check:
    cargo check -p a3s-box-code

# Generate documentation
doc:
    cargo doc -p a3s-box-code --no-deps --document-private-items

# Open documentation
doc-open:
    cargo doc -p a3s-box-code --no-deps --open

# Start the agent server (for development)
# Loads environment variables from ../src/.env and ../src/.env.local
# .env.local takes precedence over .env
# Inherits LLM env vars from shell: LLM_PROVIDER, LLM_API_KEY, LLM_MODEL, LLM_BASE_URL
# Or provider-specific: ANTHROPIC_API_KEY, OPENAI_API_KEY
# Set A3S_WORKSPACE or WORKSPACE to override default workspace location
serve:
    #!/usr/bin/env bash
    set -euo pipefail
    # Load .env from parent directory if it exists
    if [ -f ../.env ]; then
        echo "Loading environment from ../.env"
        export $(grep -v '^#' ../.env | grep -v '^$' | xargs)
    fi
    # Load .env.local from parent directory if it exists (overrides .env)
    if [ -f ../.env.local ]; then
        echo "Loading environment from ../.env.local"
        export $(grep -v '^#' ../.env.local | grep -v '^$' | xargs)
    fi
    RUST_LOG=info cargo run -p a3s-box-code

# Start the agent server with debug logging
serve-debug:
    #!/usr/bin/env bash
    set -euo pipefail
    # Load .env from parent directory if it exists
    if [ -f ../.env ]; then
        echo "Loading environment from ../.env"
        export $(grep -v '^#' ../.env | grep -v '^$' | xargs)
    fi
    # Load .env.local from parent directory if it exists (overrides .env)
    if [ -f ../.env.local ]; then
        echo "Loading environment from ../.env.local"
        export $(grep -v '^#' ../.env.local | grep -v '^$' | xargs)
    fi
    RUST_LOG=debug cargo run -p a3s-box-code

# Regenerate proto files
proto:
    cargo build -p a3s-box-code
